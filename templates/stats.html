{% extends "base.html" %}

{% block title %}Statistics - ESPN Fantasy Football{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5">
            <i class="bi bi-bar-chart text-info me-3"></i>
            League Statistics
        </h1>
        <p class="lead text-muted">Comprehensive analysis of league performance</p>
    </div>
</div>

<!-- Navigation tabs -->
<ul class="nav nav-tabs mb-4" id="statsTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="scoring-tab" data-bs-toggle="tab" data-bs-target="#scoring" type="button" role="tab">
            <i class="bi bi-graph-up me-1"></i>Scoring Records
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="season-tab" data-bs-toggle="tab" data-bs-target="#season" type="button" role="tab">
            <i class="bi bi-calendar me-1"></i>Season Stats
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="alltime-tab" data-bs-toggle="tab" data-bs-target="#alltime" type="button" role="tab">
            <i class="bi bi-trophy me-1"></i>All-Time Leaders
        </button>
    </li>
</ul>

<div class="tab-content" id="statsTabContent">
    <!-- Scoring Statistics Tab -->
    <div class="tab-pane fade show active" id="scoring" role="tabpanel">
        {% if scoring_stats %}
        <!-- Overall Scoring Stats -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-calculator me-2"></i>
                            Overall Scoring Statistics
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-2">
                                <h6>Total Games</h6>
                                <p class="h4 text-primary">{{ scoring_stats.overall_stats.total_games }}</p>
                            </div>
                            <div class="col-md-2">
                                <h6>Average Score</h6>
                                <p class="h4 text-info">{{ scoring_stats.overall_stats.average_score }}</p>
                            </div>
                            <div class="col-md-2">
                                <h6>Median Score</h6>
                                <p class="h4 text-success">{{ scoring_stats.overall_stats.median_score }}</p>
                            </div>
                            <div class="col-md-2">
                                <h6>Standard Deviation</h6>
                                <p class="h4 text-warning">{{ scoring_stats.overall_stats.std_dev }}</p>
                            </div>
                            <div class="col-md-2">
                                <h6>Score Range</h6>
                                <p class="h4 text-danger">{{ scoring_stats.overall_stats.score_range }}</p>
                            </div>
                            <div class="col-md-2">
                                <h6>Total Points</h6>
                                <p class="h4 text-secondary">{{ (scoring_stats.overall_stats.average_score * scoring_stats.overall_stats.total_games)|round(2) }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Highest Scores -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-arrow-up me-2"></i>
                            Highest Scores
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Score</th>
                                        <th>Team</th>
                                        <th>Season</th>
                                        <th>Week</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for score in scoring_stats.highest_scores[:10] %}
                                    <tr>
                                        <td>
                                            {% if loop.index <= 3 %}
                                                <span class="badge bg-warning text-dark">{{ loop.index }}</span>
                                            {% else %}
                                                {{ loop.index }}
                                            {% endif %}
                                        </td>
                                        <td><strong class="text-success">{{ score.score }}</strong></td>
                                        <td>{{ score.team_name }}</td>
                                        <td>{{ score.season }}</td>
                                        <td>
                                            {{ score.week }}
                                            {% if score.is_playoff %}
                                                <i class="bi bi-star-fill text-warning" title="Playoff game"></i>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-arrow-down me-2"></i>
                            Lowest Scores
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Score</th>
                                        <th>Team</th>
                                        <th>Season</th>
                                        <th>Week</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for score in scoring_stats.lowest_scores[:10] %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td><strong class="text-danger">{{ score.score }}</strong></td>
                                        <td>{{ score.team_name }}</td>
                                        <td>{{ score.season }}</td>
                                        <td>{{ score.week }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Season Scoring Leaders -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-award me-2"></i>
                            Season Scoring Leaders
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Season</th>
                                        <th>Team</th>
                                        <th>Total Points</th>
                                        <th>Average per Game</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for leader in scoring_stats.season_leaders %}
                                    <tr>
                                        <td><span class="badge bg-primary">{{ leader.season }}</span></td>
                                        <td><strong>{{ leader.team_name }}</strong></td>
                                        <td><span class="text-success fw-bold">{{ leader.total_points }}</span></td>
                                        <td>{{ (leader.total_points / 14)|round(2) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Season Statistics Tab -->
    <div class="tab-pane fade" id="season" role="tabpanel">
        {% if season_stats %}
        <div class="row">
            {% for season in season_stats.seasons %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white text-center">
                        <h5 class="mb-0">{{ season.season }} Season</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <small class="text-muted">Teams</small>
                                <div class="fw-bold">{{ season.total_teams }}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Games</small>
                                <div class="fw-bold">{{ season.total_games }}</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Scoring</h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <small class="text-muted">Average</small>
                                    <div class="text-info fw-bold">{{ season.average_score }}</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">High</small>
                                    <div class="text-success fw-bold">{{ season.highest_score }}</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Low</small>
                                    <div class="text-danger fw-bold">{{ season.lowest_score }}</div>
                                </div>
                            </div>
                        </div>
                        
                        {% if season.champion %}
                        <div class="mb-2">
                            <strong class="text-warning">
                                <i class="bi bi-trophy-fill me-1"></i>Champion:
                            </strong>
                            <br>{{ season.champion.name }}
                        </div>
                        {% endif %}
                        
                        {% if season.best_record %}
                        <div class="mb-2">
                            <strong class="text-success">Best Record:</strong>
                            <br>{{ season.best_record.name }} ({{ season.best_record.wins }}-{{ season.best_record.losses }})
                        </div>
                        {% endif %}
                        
                        {% if season.highest_scoring_team %}
                        <div class="mb-2">
                            <strong class="text-primary">Top Scorer:</strong>
                            <br>{{ season.highest_scoring_team.name }} ({{ season.highest_scoring_team.points_for }} pts)
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- All-Time Leaders Tab -->
    <div class="tab-pane fade" id="alltime" role="tabpanel">
        {% if all_time_stats %}
        <!-- League Totals -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-dark text-white">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h6>Total Seasons</h6>
                                <p class="h3">{{ all_time_stats.league_totals.total_seasons }}</p>
                            </div>
                            <div class="col-md-3">
                                <h6>Total Games</h6>
                                <p class="h3">{{ all_time_stats.league_totals.total_games }}</p>
                            </div>
                            <div class="col-md-3">
                                <h6>Total Points</h6>
                                <p class="h3">{{ all_time_stats.league_totals.total_points|round(2) }}</p>
                            </div>
                            <div class="col-md-3">
                                <h6>All-Time Average</h6>
                                <p class="h3">{{ all_time_stats.league_totals.average_score_all_time }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaders Cards -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-trophy me-2"></i>
                            Most Wins
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for leader in all_time_stats.leaders.most_wins %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>
                                {% if loop.index == 1 %}
                                    <i class="bi bi-trophy-fill text-warning me-1"></i>
                                {% endif %}
                                {{ leader.owner }}
                            </span>
                            <span class="badge bg-success">{{ leader.wins }} wins</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-percent me-2"></i>
                            Highest Win %
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for leader in all_time_stats.leaders.highest_win_percentage %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>
                                {% if loop.index == 1 %}
                                    <i class="bi bi-award-fill text-warning me-1"></i>
                                {% endif %}
                                {{ leader.owner }}
                            </span>
                            <span class="badge bg-info">{{ (leader.win_percentage * 100)|round(2) }}%</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up me-2"></i>
                            Most Points
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for leader in all_time_stats.leaders.most_points %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>
                                {% if loop.index == 1 %}
                                    <i class="bi bi-star-fill text-warning me-1"></i>
                                {% endif %}
                                {{ leader.owner }}
                            </span>
                            <span class="badge bg-primary">{{ leader.points_for|round(2) }} pts</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-crown me-2"></i>
                            Most Championships
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for leader in all_time_stats.leaders.most_championships %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>
                                {% if loop.index == 1 %}
                                    <i class="bi bi-crown-fill text-warning me-1"></i>
                                {% endif %}
                                {{ leader.owner }}
                            </span>
                            <span class="badge bg-warning text-dark">{{ leader.championships }} titles</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Complete All-Time Records -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul me-2"></i>
                            Complete All-Time Records
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Owner</th>
                                        <th>Seasons</th>
                                        <th>Record</th>
                                        <th>Win %</th>
                                        <th>Avg PF</th>
                                        <th>Avg PA</th>
                                        <th>Playoffs</th>
                                        <th>Championships</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for owner in all_time_stats.all_time_records %}
                                    <tr>
                                        <td><strong>{{ owner.owner }}</strong></td>
                                        <td>{{ owner.seasons_played }}</td>
                                        <td>{{ owner.wins }}-{{ owner.losses }}{% if owner.ties > 0 %}-{{ owner.ties }}{% endif %}</td>
                                        <td>{{ (owner.win_percentage * 100)|round(2) }}%</td>
                                        <td>{{ owner.avg_points_per_season }}</td>
                                        <td>{{ owner.avg_points_against_per_season }}</td>
                                        <td>{{ owner.playoff_appearances }} ({{ (owner.playoff_percentage * 100)|round(2) }}%)</td>
                                        <td>
                                            {% if owner.championships > 0 %}
                                                <span class="badge bg-warning text-dark">{{ owner.championships }}</span>
                                            {% else %}
                                                0
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if not scoring_stats and not season_stats and not all_time_stats %}
<div class="row">
    <div class="col-12">
        <div class="text-center py-5">
            <i class="bi bi-exclamation-triangle display-1 text-muted"></i>
            <h3 class="mt-3">No Statistics Available</h3>
            <p class="text-muted">Unable to load league statistics. Please check your API configuration and try refreshing.</p>
            <button class="btn btn-primary" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh Data
            </button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tabs
    const triggerTabList = document.querySelectorAll('#statsTab button');
    triggerTabList.forEach(triggerEl => {
        const tabTrigger = new bootstrap.Tab(triggerEl);
    });
    
    // Add fade-in animation to cards
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                entry.target.classList.add('fade-in');
            }
        });
    });
    
    document.querySelectorAll('.card').forEach((card) => {
        observer.observe(card);
    });
});
</script>
{% endblock %}
